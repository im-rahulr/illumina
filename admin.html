<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin ‚Äì Lowry Mastermind</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y0TXQST3MG"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-Y0TXQST3MG');
  </script>
</head>
<body>
  <div id="siteBanner" class="site-banner" role="region" aria-label="Announcement" style="display:none">
    <span><strong>New trial is out</strong> ‚Äî follow updates at</span>
    <a href="https://www.instagram.com/lac_cultural_department/" target="_blank" rel="noopener">@lac_cultural_department</a>
    <button id="closeBanner" class="banner-close" aria-label="Close announcement">√ó</button>
  </div>
  <main class="container" role="main">
    <h1 class="title">Admin</h1>

    <form id="admin-login" class="form-card" style="max-width:480px;">
      <div class="form-grid">
        <div class="form-group">
          <label for="adminUser">Username</label>
          <input id="adminUser" class="input" type="text" placeholder="admin" required>
        </div>
        <div class="form-group">
          <label for="adminPass">Password</label>
          <div class="input-row">
            <input id="adminPass" class="input" type="password" placeholder="Password" required>
            <button id="togglePass" class="btn-icon" type="button" aria-label="Show password">üëÅÔ∏è</button>
          </div>
        </div>
        <button class="btn btn-primary" type="submit">Login</button>      </div>
    </form>

    <section id="admin-panel" style="display:none; width:100%;">
      <div class="toolbar">
        <div class="meta">Registrations <span class="live"><span id="liveDot" class="live-dot"></span>Live</span></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <input id="searchBox" class="input search" placeholder="Search name, ID, IP..." />
          <button id="exportCsv" class="btn btn-dark">Export CSV</button>
        </div>
      </div>
      <div class="filters">
        <span id="totalBadge" class="stat-badge">Total: 0</span>
        <label class="helper">Course</label>
        <select id="filterCourse" class="input">
          <option value="">All</option>
          <option>BBA</option>
          <option>BCA</option>
          <option>BCOM</option>
        </select>
        <label class="helper">Year</label>
        <select id="filterYear" class="input">
          <option value="">All</option>
          <option>1</option>
          <option>2</option>
          <option>3</option>
        </select>
      </div>
      <div class="charts">
        <div class="chart-card"><canvas id="byCourse"></canvas></div>
        <div class="chart-card"><canvas id="byYear"></canvas></div>
      </div>
      <div class="table-wrap">
        <div id="tableLoading" class="loading-overlay"><div class="spinner-standalone"></div></div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Username</th>
              <th>Course</th>
              <th>Student ID</th>
              <th>Year</th>
              <th>IP</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
        <div id="emptyState" class="empty-state" style="display:none;">No results match your filter.</div>
      </div>
    </section>
  </main>

  <!-- <footer class="footer" role="contentinfo">
    <small>Designed by CodeCraft ‚Ä¢ <a class="login-link" href="https://www.instagram.com/lac_cultural_department/" target="_blank" rel="noopener">Instagram</a></small>
  </footer> -->

  <script type="module">
    import { db } from './firebase-config.js';
    import { collection, getDocs, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // db is imported from firebase-config.js

    // Announcement banner logic
    try {
      const dismissed = localStorage.getItem('bannerDismissed') === '1';
      const banner = document.getElementById('siteBanner');
      if (!dismissed && banner) {
        banner.style.display = 'flex';
        document.body.classList.add('with-banner');
        const h = banner.getBoundingClientRect().height;
        document.documentElement.style.setProperty('--banner-h', h + 'px');
        const btn = document.getElementById('closeBanner');
        if (btn) btn.addEventListener('click', () => {
          banner.style.display = 'none';
          document.body.classList.remove('with-banner');
          localStorage.setItem('bannerDismissed','1');
        });
      }
    } catch {}

    const loginForm = document.getElementById('admin-login');
    const panel = document.getElementById('admin-panel');
    const toggleBtn = document.getElementById('togglePass');
    toggleBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const input = document.getElementById('adminPass');
      const isPwd = input.type === 'password';
      input.type = isPwd ? 'text' : 'password';
      toggleBtn.setAttribute('aria-label', isPwd ? 'Hide password' : 'Show password');
    });
    // Auto-fill if remembered
    const remembered = localStorage.getItem('adminRemember') === '1';
    if (remembered) {
      document.getElementById('adminUser').value = 'admin';
      document.getElementById('adminPass').value = 'lowry@123';
    }

    // Add remember me toggle
    const rememberToggle = document.createElement('label');
    rememberToggle.className = 'helper';
    rememberToggle.style.display = 'inline-flex';
    rememberToggle.style.alignItems = 'center';
    rememberToggle.style.gap = '6px';
    rememberToggle.innerHTML = `<input id="rememberMe" type="checkbox" ${remembered ? 'checked' : ''}> Remember me`;
    loginForm.querySelector('.form-grid').appendChild(rememberToggle);

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const u = document.getElementById('adminUser').value.trim();
      const p = document.getElementById('adminPass').value;
      // Allow quick login even if form auto-capitalizes
      if (u.toLowerCase() === 'admin' && p === 'lowry@123') {
        localStorage.setItem('adminRemember', document.getElementById('rememberMe').checked ? '1' : '0');
        loginForm.style.display = 'none';
        panel.style.display = '';
        await initDataFeed();
      } else {
        alert('Invalid credentials');
      }
    });

    let unsubscribe = null;
    async function initDataFeed(){
      const tbody = document.getElementById('rows');
      tbody.innerHTML = '';
      document.getElementById('tableLoading').classList.add('show');
      let qRef;
      try {
        qRef = query(collection(db, 'registrations'), orderBy('createdAt', 'desc'));
      } catch (e) {
        qRef = collection(db, 'registrations');
      }
      if (unsubscribe) unsubscribe();
      unsubscribe = onSnapshot(qRef, (snap) => {
        const rows = [];
        snap.forEach(doc => rows.push({ id: doc.id, ...doc.data() }));
        renderWithFilters(rows);
        document.getElementById('tableLoading').classList.remove('show');
        document.getElementById('liveDot').classList.add('on');
      }, (err) => {
        alert('Failed to read data. Check Firestore rules and that the database is enabled.');
        console.error(err);
        document.getElementById('tableLoading').classList.remove('show');
        document.getElementById('liveDot').classList.remove('on');
      });
    }

    function renderWithFilters(all){
      const tbody = document.getElementById('rows');
      const fc = document.getElementById('filterCourse').value;
      const fy = document.getElementById('filterYear').value;
      const q = document.getElementById('searchBox').value.trim().toLowerCase();
      const filtered = all.filter(r => (fc ? r.course === fc : true) && (fy ? String(r.year) === fy : true) && (
        q ? (
          String(r.username||'').toLowerCase().includes(q) ||
          String(r.studentId||'').toLowerCase().includes(q) ||
          String(r.ip||'').toLowerCase().includes(q)
        ) : true
      ));
      document.getElementById('totalBadge').textContent = `Total: ${filtered.length}`;
      tbody.innerHTML = '';
      let idx = 1;
      const byCourse = { BBA:0, BCA:0, BCOM:0, Other:0 };
      const byYear = { '1':0, '2':0, '3':0, Other:0 };
      filtered.forEach(d => {
        const tr = document.createElement('tr');
        const created = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : '';
        tr.innerHTML = `<td>${idx++}</td><td>${escapeHtml(d.username||'')}</td><td>${escapeHtml(d.course||'')}</td><td>${escapeHtml(d.studentId||'')}</td><td>${escapeHtml(d.year||'')}</td><td>${escapeHtml(d.ip||'')}</td><td>${created}</td>`;
        tbody.appendChild(tr);
        const cKey = ['BBA','BCA','BCOM'].includes(d.course) ? d.course : 'Other';
        byCourse[cKey]++;
        const yKey = ['1','2','3'].includes(String(d.year)) ? String(d.year) : 'Other';
        byYear[yKey]++;
      });
      renderCharts(byCourse, byYear);
      // Save last dataset for re-render on filter change
      window.__lastAllRows = all;
      document.getElementById('emptyState').style.display = filtered.length ? 'none' : '';
    }

    document.getElementById('filterCourse').addEventListener('change', () => {
      if (window.__lastAllRows) renderWithFilters(window.__lastAllRows);
    });
    document.getElementById('filterYear').addEventListener('change', () => {
      if (window.__lastAllRows) renderWithFilters(window.__lastAllRows);
    });
    document.getElementById('searchBox').addEventListener('input', () => {
      if (window.__lastAllRows) renderWithFilters(window.__lastAllRows);
    });

    let __courseChart = null, __yearChart = null;
    async function renderCharts(byCourse, byYear){
      const { Chart } = await import('https://cdn.jsdelivr.net/npm/chart.js@4.4.3/auto/+esm');
      const cc = document.getElementById('byCourse');
      const cy = document.getElementById('byYear');
      // Color palettes
      const courseColorMap = { BBA: '#4dabf7', BCA: '#845ef7', BCOM: '#ffa94d', Other: '#adb5bd' };
      const courseLabels = Object.keys(byCourse);
      const courseColors = courseLabels.map(l => courseColorMap[l] || '#74c0fc');
      const courseConfig = {
        type: 'bar',
        data: {
          labels: courseLabels,
          datasets: [{
            label: 'By Course',
            data: Object.values(byCourse),
            backgroundColor: courseColors,
            borderColor: courseColors,
            borderWidth: 1
          }]
        },
        options: {
          plugins: { legend: { labels: { color: '#fff' } } },
          scales: {
            x: { ticks: { color: '#B3B3B3' }, grid: { color: '#31302F' } },
            y: { ticks: { color: '#B3B3B3' }, grid: { color: '#31302F' }, beginAtZero: true }
          }
        }
      };
      if (__courseChart) __courseChart.destroy();
      __courseChart = new Chart(cc, courseConfig);

      const yearLabels = Object.keys(byYear);
      const yearColorMap = { '1': '#4dabf7', '2': '#ffa94d', '3': '#e64980', Other: '#495057' };
      const yearColors = yearLabels.map(l => yearColorMap[l] || '#74c0fc');

      const yearConfig = {
        type: 'doughnut',
        data: {
          labels: yearLabels,
          datasets: [{
            label: 'By Year',
            data: Object.values(byYear),
            backgroundColor: yearColors
          }]
        },
        options: { plugins: { legend: { labels: { color: '#fff' } } } }
      };
      if (__yearChart) __yearChart.destroy();
      __yearChart = new Chart(cy, yearConfig);
    }

    document.getElementById('exportCsv').addEventListener('click', async () => {
      const q = query(collection(db, 'registrations'), orderBy('createdAt', 'desc'));
      const snap = await getDocs(q);
      const rows = [['#','username','course','studentId','year','ip','createdAt']];
      let i = 1;
      snap.forEach(doc => {
        const d = doc.data();
        const created = d.createdAt?.toDate ? d.createdAt.toDate().toISOString() : '';
        rows.push([i++, d.username||'', d.course||'', d.studentId||'', d.year||'', d.ip||'', created]);
      });
      const csv = rows.map(r => r.map(v => '"' + String(v).replaceAll('"','""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'registrations.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    function escapeHtml(s){
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }
  </script>
</body>
</html>


