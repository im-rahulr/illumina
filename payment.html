<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Online Payment ‚Äì illumina</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=4">
  <style>
    /* Enhanced payment flow styles */
    .payment-status-message {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .btn.is-loading .btn-label {
      opacity: 0.7;
    }
    
    .btn-secondary {
      transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(123, 191, 68, 0.3);
    }
    
    /* Security indicator */
    .security-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(40, 167, 69, 0.1);
      color: #28a745;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }
    
    .security-badge::before {
      content: 'üîí';
      font-size: 10px;
    }
  </style>
  <meta name="description" content="Pay your registration fee online via UPI." />
</head>
<body>
  <main class="container" role="main" style="min-height:100vh; padding: 24px 0; display: flex; align-items: center; justify-content: center;">
    <div style="max-width: 400px; margin: 0 auto; padding: 0 16px; width: 100%;">
      <h1 class="title" style="text-align: center; margin-bottom: 4px;">Pay ‚Çπ200</h1>
      <p class="subtitle" style="text-align: center; margin-top: 0;">Scan the QR code to pay using any UPI app</p>

      <section class="form-card" style="background: var(--surface); border:1px solid var(--line); border-radius: 12px; padding: 24px; display: flex; flex-direction: column; align-items: center; gap: 20px;">
        <div style="text-align: center;">
          <div style="background: #fff; border-radius: 12px; padding: 16px; display: inline-block; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <img src="images/qrcode.png" alt="Payment QR Code" style="width: 200px; height: 200px; display: block;" />
          </div>
          <div class="helper" style="margin: 12px 0 0; font-weight: 500; text-align: center;">
            <div style="margin-top: 12px; font-size: 15px; font-weight: 600; color: #fff;">Name: MADHAVI</div>
            <div style="margin-top: 4px; font-size: 13px; color: var(--muted);">UPI ID: madhavi@paytm</div>
          </div>
        </div>

        <div style="display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap;">
          <img src="images/gpay.png" alt="Google Pay" style="width: 40px; height: 40px; border-radius: 8px;" />
          <img src="images/phonepe.png" alt="PhonePe" style="width: 40px; height: 40px; border-radius: 8px;" />
          <img src="images/upi.png" alt="UPI" style="width: 40px; height: 40px; border-radius: 8px;" />
        </div>

        <div style="text-align: center; width: 100%;">
          <div class="helper" style="margin-bottom: 16px; color: var(--muted);">Or tap the button below to open your UPI app directly</div>
          <button id="openUpiBtn" class="btn btn-primary" style="width: 100%; font-weight: 600;">
            <span class="btn-label">Pay Now</span>
          </button>
        </div>

        <div class="helper" style="text-align: center; color: var(--muted); font-size: 12px;">
          After payment, you'll receive a confirmation. Please save the transaction ID for your records.
          <div class="security-badge" style="margin-top: 8px;">
            Secure Payment Gateway
          </div>
        </div>
      </section>

      <div style="text-align: center; margin-top: 16px;">
        <a href="success.html" class="login-link" style="font-size: 14px;">‚Üê Back to registration</a>
        <span style="margin: 0 8px; color: var(--muted);">‚Ä¢</span>
        <a href="payment-status.html" class="login-link" style="font-size: 14px;">Check Status</a>
      </div>
    </div>
  </main>

  <!-- Page Loader Overlay -->
  <div id="pageLoader" class="page-loader" aria-live="polite" aria-busy="false">
    <div class="spinner-standalone" aria-hidden="true"></div>
    <div id="loaderText" class="loader-text">Opening your UPI app‚Ä¶</div>
  </div>

  <script>
    // Secure UPI payment configuration
    const UPI_CONFIG = {
      id: 'madhavi@paytm',
      amount: '200',
      merchantName: 'MADHAVI',
      transactionNote: 'illumina Registration Fee',
      whatsappNumber: '9739904620'
    };

    // Payment state management
    const PaymentState = {
      INITIAL: 'initial',
      UPI_OPENED: 'upi_opened',
      AWAITING_VERIFICATION: 'awaiting_verification',
      VERIFIED: 'verified'
    };

    let currentState = PaymentState.INITIAL;
    let transactionId = null;
    let paymentTimestamp = null;

    const openUpiBtn = document.getElementById('openUpiBtn');
    const pageLoader = document.getElementById('pageLoader');
    const loaderText = document.getElementById('loaderText');

    // Generate secure transaction ID with validation
    function generateTransactionId() {
      const timestamp = Date.now();
      const random = Math.floor(Math.random() * 10000);
      const userContext = getUserContext();
      
      // Include user token hash for additional security
      let hashComponent = '';
      if (userContext?.token) {
        hashComponent = userContext.token.slice(-3);
      }
      
      return `ILM${timestamp}${random}${hashComponent}`.slice(-16);
    }

    // Validate payment session integrity
    function validatePaymentSession() {
      const userContext = getUserContext();
      const paymentContext = getPaymentContext();
      
      if (!userContext) {
        throw new Error('User session expired. Please restart from registration.');
      }
      
      if (paymentContext) {
        const timeDiff = Date.now() - new Date(paymentContext.timestamp).getTime();
        if (timeDiff > 30 * 60 * 1000) { // 30 minutes
          throw new Error('Payment session expired. Please restart.');
        }
      }
      
      return true;
    }

    // Get payment context from session storage
    function getPaymentContext() {
      try {
        const context = sessionStorage.getItem('payment_context');
        return context ? JSON.parse(context) : null;
      } catch (e) {
        console.warn('Unable to get payment context:', e);
        return null;
      }
    }

    // Build secure UPI payment link
    function buildSecureUpiLink() {
      transactionId = generateTransactionId();
      paymentTimestamp = new Date().toISOString();
      
      // Store transaction context securely
      try {
        sessionStorage.setItem('payment_context', JSON.stringify({
          transactionId,
          timestamp: paymentTimestamp,
          amount: UPI_CONFIG.amount,
          merchantName: UPI_CONFIG.merchantName
        }));
      } catch (e) {
        console.warn('Unable to store payment context:', e);
      }

      const params = new URLSearchParams({
        pa: UPI_CONFIG.id,
        pn: UPI_CONFIG.merchantName,
        am: UPI_CONFIG.amount,
        cu: 'INR',
        tn: `${UPI_CONFIG.transactionNote} - ${transactionId}`,
        tr: transactionId // Transaction reference
      });
      
      return `upi://pay?${params.toString()}`;
    }

    // Get user context from session storage
    function getUserContext() {
      try {
        const userContext = sessionStorage.getItem('payment_user_context');
        return userContext ? JSON.parse(userContext) : null;
      } catch (e) {
        console.warn('Unable to get user context:', e);
        return null;
      }
    }

    // Build WhatsApp verification link with context
    function buildWhatsAppLink(userContext = null) {
      let message = 'hello';
      
      if (userContext && transactionId) {
        message = `Hello! I have completed payment for illumina registration.
        
Details:
‚Ä¢ Name: ${userContext.name}
‚Ä¢ Token: ${userContext.token}
‚Ä¢ Transaction ID: ${transactionId}
‚Ä¢ Amount: ‚Çπ${UPI_CONFIG.amount}
‚Ä¢ Time: ${new Date().toLocaleString()}

Please confirm my payment status.`;
      }
      
      return `https://wa.me/${UPI_CONFIG.whatsappNumber}?text=${encodeURIComponent(message)}`;
    }

    // Track payment events for analytics
    function trackPaymentEvent(eventName, data = {}) {
      try {
        // Send to analytics if available
        if (typeof gtag !== 'undefined') {
          gtag('event', eventName, {
            event_category: 'payment',
            event_label: 'upi_payment',
            custom_parameter: JSON.stringify(data)
          });
        }
        
        // Send to PostHog if available
        if (typeof posthog !== 'undefined') {
          posthog.capture(eventName, {
            category: 'payment',
            ...data
          });
        }
        
        console.log('Payment event tracked:', eventName, data);
      } catch (e) {
        console.warn('Failed to track payment event:', e);
      }
    }

    // Update button state based on payment flow
    function updateButtonState(state) {
      currentState = state;
      
      switch (state) {
        case PaymentState.INITIAL:
          openUpiBtn.innerHTML = '<span class="btn-label">Pay Now</span>';
          openUpiBtn.className = 'btn btn-primary';
          openUpiBtn.style.width = '100%';
          openUpiBtn.style.fontWeight = '600';
          break;
          
        case PaymentState.UPI_OPENED:
          openUpiBtn.innerHTML = '<span class="btn-label">Opening UPI App...</span>';
          openUpiBtn.disabled = true;
          openUpiBtn.className = 'btn btn-primary is-loading';
          break;
          
        case PaymentState.AWAITING_VERIFICATION:
          openUpiBtn.innerHTML = '<span class="btn-label">Check Payment Status</span>';
          openUpiBtn.disabled = false;
          openUpiBtn.className = 'btn btn-secondary';
          openUpiBtn.style.background = 'var(--primary)';
          openUpiBtn.style.color = '#10210a';
          break;
          
        case PaymentState.VERIFIED:
          openUpiBtn.innerHTML = '<span class="btn-label">‚úì Payment Verified</span>';
          openUpiBtn.disabled = true;
          openUpiBtn.className = 'btn btn-primary';
          openUpiBtn.style.background = '#28a745';
          break;
      }
    }

    // Show/hide loader with enhanced messaging
    function showLoader(message, isError = false) {
      if (loaderText) {
        loaderText.textContent = message || 'Processing...';
        loaderText.style.color = isError ? '#ff6b6b' : 'var(--text)';
      }
      if (pageLoader) {
        pageLoader.classList.add('show');
        pageLoader.setAttribute('aria-busy', 'true');
      }
    }

    function hideLoader() {
      if (pageLoader) {
        pageLoader.classList.remove('show');
        pageLoader.setAttribute('aria-busy', 'false');
      }
    }

    // Handle UPI payment initiation
    function initiateUpiPayment() {
      try {
        // Validate user context before proceeding
        const userContext = getUserContext();
        if (!userContext) {
          throw new Error('User context not found. Please restart from registration.');
        }
        
        updateButtonState(PaymentState.UPI_OPENED);
        showLoader('Securing transaction and redirecting to UPI app...');
        
        const upiLink = buildSecureUpiLink();
        console.log('Initiating secure UPI payment with transaction ID:', transactionId);
        
        // Track payment initiation
        trackPaymentEvent('payment_initiated', {
          transactionId,
          amount: UPI_CONFIG.amount,
          userToken: userContext.token,
          timestamp: paymentTimestamp
        });
        
        // Add security delay to prevent rapid-fire attempts
        setTimeout(() => {
          // Attempt to open UPI app
          window.location.href = upiLink;
          
          // Track UPI app opening
          trackPaymentEvent('upi_app_opened', {
            transactionId,
            timestamp: new Date().toISOString()
          });
        }, 500);
        
        // Handle return from UPI app
        setTimeout(() => {
          hideLoader();
          updateButtonState(PaymentState.AWAITING_VERIFICATION);
          
          // Show success message with next steps
          showPaymentStatusMessage();
          
          // Track return from UPI app
          trackPaymentEvent('returned_from_upi', {
            transactionId,
            timestamp: new Date().toISOString()
          });
        }, 3000);
        
      } catch (error) {
        console.error('UPI payment initiation failed:', error);
        trackPaymentEvent('payment_initiation_failed', { 
          error: error.message,
          timestamp: new Date().toISOString()
        });
        showLoader('Payment failed. Please try again.', true);
        setTimeout(() => {
          hideLoader();
          updateButtonState(PaymentState.INITIAL);
        }, 2000);
      }
    }

    // Handle payment status verification via WhatsApp
    function verifyPaymentStatus() {
      try {
        showLoader('Redirecting to WhatsApp for verification...');
        
        // Get user context for personalized message
        const userContext = getUserContext();
        const whatsappLink = buildWhatsAppLink(userContext);
        console.log('Redirecting to WhatsApp for payment verification');
        
        // Track verification attempt
        trackPaymentEvent('verification_initiated', {
          transactionId,
          userToken: userContext?.token,
          timestamp: new Date().toISOString()
        });
        
        // Open WhatsApp in new tab/window
        const whatsappWindow = window.open(whatsappLink, '_blank');
        
        setTimeout(() => {
          hideLoader();
          
          // Check if WhatsApp opened successfully
          if (whatsappWindow && !whatsappWindow.closed) {
            showVerificationMessage();
            updateButtonState(PaymentState.VERIFIED);
          } else {
            // Fallback: direct navigation
            window.location.href = whatsappLink;
          }
        }, 1000);
        
      } catch (error) {
        console.error('WhatsApp verification failed:', error);
        trackPaymentEvent('verification_failed', { error: error.message });
        showLoader('Verification failed. Please contact support.', true);
        setTimeout(() => {
          hideLoader();
        }, 2000);
      }
    }

    // Show payment status message
    function showPaymentStatusMessage() {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'payment-status-message';
      messageDiv.style.cssText = `
        background: rgba(123, 191, 68, 0.1);
        border: 1px solid var(--primary);
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
        text-align: center;
        color: var(--text);
        font-size: 14px;
        line-height: 1.5;
      `;
      
      messageDiv.innerHTML = `
        <div style="color: var(--primary); font-weight: 600; margin-bottom: 8px;">
          ‚úì UPI App Opened Successfully
        </div>
        <div>
          If you completed the payment, click "Check Payment Status" below to verify your transaction.
        </div>
        <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">
          Transaction ID: ${transactionId}
        </div>
      `;
      
      // Insert after the form card
      const formCard = document.querySelector('.form-card');
      formCard.parentNode.insertBefore(messageDiv, formCard.nextSibling);
    }

    // Show verification message
    function showVerificationMessage() {
      const existingMessage = document.querySelector('.payment-status-message');
      if (existingMessage) {
        existingMessage.innerHTML = `
          <div style="color: var(--primary); font-weight: 600; margin-bottom: 8px;">
            üì± WhatsApp Opened
          </div>
          <div>
            Please send "hello" to verify your payment. Our team will confirm your transaction shortly.
          </div>
          <div style="margin-top: 12px; padding: 8px; background: var(--surface); border-radius: 6px; font-size: 12px;">
            <strong>Next Steps:</strong><br>
            1. Send the message in WhatsApp<br>
            2. Share your transaction screenshot<br>
            3. Wait for confirmation
          </div>
        `;
      }
    }

    // Handle visibility change (user returning from UPI app)
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && currentState === PaymentState.UPI_OPENED) {
        console.log('User returned from UPI app');
        setTimeout(() => {
          if (currentState === PaymentState.UPI_OPENED) {
            hideLoader();
            updateButtonState(PaymentState.AWAITING_VERIFICATION);
            showPaymentStatusMessage();
          }
        }, 500);
      }
    });

    // Handle page focus (alternative detection method)
    window.addEventListener('focus', () => {
      if (currentState === PaymentState.UPI_OPENED) {
        console.log('Page focused - user likely returned from UPI app');
        setTimeout(() => {
          if (currentState === PaymentState.UPI_OPENED) {
            hideLoader();
            updateButtonState(PaymentState.AWAITING_VERIFICATION);
            showPaymentStatusMessage();
          }
        }, 1000);
      }
    });

    // Main button click handler with security validation
    openUpiBtn.addEventListener('click', () => {
      // Detect suspicious activity
      if (detectSuspiciousActivity()) {
        return;
      }
      
      try {
        // Validate payment session before proceeding
        validatePaymentSession();
        
        switch (currentState) {
          case PaymentState.INITIAL:
            initiateUpiPayment();
            break;
            
          case PaymentState.AWAITING_VERIFICATION:
            verifyPaymentStatus();
            break;
            
          default:
            console.log('Button clicked in state:', currentState);
        }
      } catch (error) {
        console.error('Payment validation failed:', error);
        trackPaymentEvent('validation_failed', {
          error: error.message,
          state: currentState,
          timestamp: new Date().toISOString()
        });
        
        showLoader(error.message, true);
        setTimeout(() => {
          hideLoader();
          // Redirect back to registration if session is invalid
          if (error.message.includes('session')) {
            window.location.href = 'register.html';
          }
        }, 3000);
      }
    });

    // Initialize payment state on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Check user context from registration flow
      try {
        const userContext = sessionStorage.getItem('payment_user_context');
        if (userContext) {
          const userData = JSON.parse(userContext);
          console.log('Payment initiated for user:', userData.name, 'Token:', userData.token);
          
          // Update page title with user info
          const titleElement = document.querySelector('.title');
          if (titleElement && userData.name) {
            titleElement.innerHTML = `Pay ‚Çπ200<br><small style="font-size: 16px; color: var(--muted); font-weight: 400;">for ${userData.name}</small>`;
          }
        }
      } catch (e) {
        console.warn('Unable to load user context:', e);
      }
      
      // Check if returning from a previous payment attempt
      try {
        const savedContext = sessionStorage.getItem('payment_context');
        if (savedContext) {
          const context = JSON.parse(savedContext);
          const timeDiff = Date.now() - new Date(context.timestamp).getTime();
          
          // If less than 10 minutes ago, assume payment might be pending
          if (timeDiff < 10 * 60 * 1000) {
            transactionId = context.transactionId;
            paymentTimestamp = context.timestamp;
            updateButtonState(PaymentState.AWAITING_VERIFICATION);
            showPaymentStatusMessage();
          }
        }
      } catch (e) {
        console.warn('Unable to restore payment context:', e);
      }
      
      console.log('Secure payment system initialized');
    });

    // Enhanced error handling and security monitoring
    window.addEventListener('error', (event) => {
      if (currentState !== PaymentState.INITIAL) {
        console.error('Payment flow error:', event.error);
        
        // Track error for monitoring
        trackPaymentEvent('payment_error', {
          error: event.error?.message || 'Unknown error',
          state: currentState,
          transactionId: transactionId,
          timestamp: new Date().toISOString()
        });
        
        showLoader('An error occurred. Please try again.', true);
        setTimeout(() => {
          hideLoader();
          updateButtonState(PaymentState.INITIAL);
        }, 3000);
      }
    });

    // Monitor for suspicious activity
    let clickCount = 0;
    let lastClickTime = 0;
    
    function detectSuspiciousActivity() {
      const now = Date.now();
      if (now - lastClickTime < 1000) { // Less than 1 second between clicks
        clickCount++;
        if (clickCount > 3) {
          console.warn('Suspicious rapid clicking detected');
          trackPaymentEvent('suspicious_activity', {
            type: 'rapid_clicking',
            count: clickCount,
            timestamp: new Date().toISOString()
          });
          
          showLoader('Please wait before trying again.', true);
          setTimeout(() => {
            hideLoader();
            clickCount = 0;
          }, 5000);
          return true;
        }
      } else {
        clickCount = 0;
      }
      lastClickTime = now;
      return false;
    }

    // Save payment attempt to Firebase for admin tracking
    async function savePaymentAttempt(status, details = {}) {
      try {
        const userContext = getUserContext();
        if (!userContext) return;
        
        // Import Firebase functions
        const { db } = await import('./firebase-config.js');
        const { collection, addDoc, serverTimestamp } = await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js");
        
        const paymentData = {
          userToken: userContext.token,
          userName: userContext.name,
          transactionId: transactionId,
          amount: UPI_CONFIG.amount,
          status: status,
          timestamp: serverTimestamp(),
          details: details,
          upiId: UPI_CONFIG.id,
          merchantName: UPI_CONFIG.merchantName
        };
        
        await addDoc(collection(db, 'paymentAttempts'), paymentData);
        console.log('Payment attempt saved to Firebase');
        
      } catch (error) {
        console.warn('Failed to save payment attempt:', error);
      }
    }

    // Enhanced verification message with Firebase integration
    function showVerificationMessage() {
      const existingMessage = document.querySelector('.payment-status-message');
      if (existingMessage) {
        existingMessage.innerHTML = `
          <div style="color: var(--primary); font-weight: 600; margin-bottom: 8px;">
            üì± WhatsApp Verification Sent
          </div>
          <div>
            Your payment details have been sent to our verification team. You'll receive confirmation shortly.
          </div>
          <div style="margin-top: 12px; padding: 8px; background: var(--surface); border-radius: 6px; font-size: 12px;">
            <strong>What happens next:</strong><br>
            1. Our team will verify your payment<br>
            2. You'll receive confirmation via WhatsApp<br>
            3. Your registration will be activated<br>
            4. You can download your ticket
          </div>
          <div style="margin-top: 8px; font-size: 11px; color: var(--muted);">
            Verification usually takes 5-10 minutes during business hours.
          </div>
        `;
        
        // Save verification attempt to Firebase
        savePaymentAttempt('verification_sent', {
          whatsappNumber: UPI_CONFIG.whatsappNumber,
          verificationTime: new Date().toISOString()
        });
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (currentState === PaymentState.VERIFIED) {
        sessionStorage.removeItem('payment_context');
        
        // Save completion status
        savePaymentAttempt('completed', {
          completionTime: new Date().toISOString()
        });
      }
    });
  </script>
</body>
</html>